{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.BracketsManager = void 0;\nconst create_1 = require(\"./create\");\nconst get_1 = require(\"./get\");\nconst update_1 = require(\"./update\");\nconst delete_1 = require(\"./delete\");\nconst find_1 = require(\"./find\");\nconst reset_1 = require(\"./reset\");\nconst uuid_1 = require(\"uuid\");\nconst helpers = require(\"./helpers\");\n/**\n * A class to handle tournament management at those levels: `stage`, `group`, `round`, `match` and `match_game`.\n */\nclass BracketsManager {\n  /**\n   * Creates an instance of BracketsManager, which will handle all the stuff from the library.\n   *\n   * @param storageInterface An implementation of CrudInterface.\n   * @param verbose Whether to log CRUD operations.\n   */\n  constructor(storageInterface, verbose) {\n    this.verbose = false;\n    this.verbose = verbose !== null && verbose !== void 0 ? verbose : false;\n    this.storage = storageInterface;\n    this.instrumentStorage();\n    // eslint-disable-next-line @typescript-eslint/explicit-function-return-type\n    this.storage.selectFirst = async (table, filter, assertUnique = true) => {\n      var _a;\n      const results = await this.storage.select(table, filter);\n      if (!results || results.length === 0) return null;\n      if (assertUnique && results.length > 1) throw Error(`Selecting ${JSON.stringify(filter)} on table \"${table}\" must return a unique value.`);\n      return (_a = results[0]) !== null && _a !== void 0 ? _a : null;\n    };\n    // eslint-disable-next-line @typescript-eslint/explicit-function-return-type\n    this.storage.selectLast = async (table, filter, assertUnique = true) => {\n      var _a;\n      const results = await this.storage.select(table, filter);\n      if (!results || results.length === 0) return null;\n      if (assertUnique && results.length > 1) throw Error(`Selecting ${JSON.stringify(filter)} on table \"${table}\" must return a unique value.`);\n      return (_a = results[results.length - 1]) !== null && _a !== void 0 ? _a : null;\n    };\n    const create = new create_1.Create(this.storage);\n    const createStageFunction = create.stage.bind(this);\n    this.create = Object.assign(createStageFunction, {\n      stage: createStageFunction\n    });\n    this.get = new get_1.Get(this.storage);\n    this.update = new update_1.Update(this.storage);\n    this.delete = new delete_1.Delete(this.storage);\n    this.find = new find_1.Find(this.storage);\n    this.reset = new reset_1.Reset(this.storage);\n  }\n  /**\n   * Imports data in the database.\n   *\n   * @param data Data to import.\n   * @param normalizeIds Enable ID normalization: all IDs (and references to them) are remapped to consecutive IDs starting from 0.\n   */\n  async import(data, normalizeIds = false) {\n    if (normalizeIds) data = helpers.normalizeIds(data);\n    if (!(await this.storage.delete('participant'))) throw Error('Could not empty the participant table.');\n    if (!(await this.storage.insert('participant', data.participant))) throw Error('Could not import participants.');\n    if (!(await this.storage.delete('stage'))) throw Error('Could not empty the stage table.');\n    if (!(await this.storage.insert('stage', data.stage))) throw Error('Could not import stages.');\n    if (!(await this.storage.delete('group'))) throw Error('Could not empty the group table.');\n    if (!(await this.storage.insert('group', data.group))) throw Error('Could not import groups.');\n    if (!(await this.storage.delete('round'))) throw Error('Could not empty the round table.');\n    if (!(await this.storage.insert('round', data.round))) throw Error('Could not import rounds.');\n    if (!(await this.storage.delete('match'))) throw Error('Could not empty the match table.');\n    if (!(await this.storage.insert('match', data.match))) throw Error('Could not import matches.');\n    if (!(await this.storage.delete('match_game'))) throw Error('Could not empty the match_game table.');\n    if (!(await this.storage.insert('match_game', data.match_game))) throw Error('Could not import match games.');\n  }\n  /**\n   * Exports data from the database.\n   */\n  async export() {\n    const participants = await this.storage.select('participant');\n    if (!participants) throw Error('Error getting participants.');\n    const stages = await this.storage.select('stage');\n    if (!stages) throw Error('Error getting stages.');\n    const groups = await this.storage.select('group');\n    if (!groups) throw Error('Error getting groups.');\n    const rounds = await this.storage.select('round');\n    if (!rounds) throw Error('Error getting rounds.');\n    const matches = await this.storage.select('match');\n    if (!matches) throw Error('Error getting matches.');\n    const matchGames = await this.get.matchGames(matches);\n    return {\n      participant: participants,\n      stage: stages,\n      group: groups,\n      round: rounds,\n      match: matches,\n      match_game: matchGames\n    };\n  }\n  /**\n   * Add `console.log()` to storage methods in verbose mode.\n   */\n  instrumentStorage() {\n    const storage = this.storage;\n    const instrumentedMethods = ['insert', 'select', 'update', 'delete'];\n    for (const method of Object.getOwnPropertyNames(Object.getPrototypeOf(storage))) {\n      if (!instrumentedMethods.includes(method)) continue;\n      const originalMethod = storage[method].bind(storage);\n      storage[method] = async (table, ...args) => {\n        const verbose = this.verbose;\n        let id;\n        let start;\n        if (verbose) {\n          id = (0, uuid_1.v4)();\n          start = Date.now();\n          console.log(`${id} ${method.toUpperCase()} \"${table}\" args: ${JSON.stringify(args)}`);\n        }\n        const result = await originalMethod(table, ...args);\n        if (verbose) {\n          // eslint-disable-next-line @typescript-eslint/no-unnecessary-type-assertion\n          const duration = Date.now() - start;\n          // eslint-disable-next-line @typescript-eslint/no-unnecessary-type-assertion\n          console.log(`${id} ${duration}ms - Returned ${JSON.stringify(result)}`);\n        }\n        return result;\n      };\n    }\n  }\n}\nexports.BracketsManager = BracketsManager;","map":{"version":3,"names":["create_1","require","get_1","update_1","delete_1","find_1","reset_1","uuid_1","helpers","BracketsManager","constructor","storageInterface","verbose","storage","instrumentStorage","selectFirst","table","filter","assertUnique","results","select","length","Error","JSON","stringify","_a","selectLast","create","Create","createStageFunction","stage","bind","Object","assign","get","Get","update","Update","delete","Delete","find","Find","reset","Reset","import","data","normalizeIds","insert","participant","group","round","match","match_game","export","participants","stages","groups","rounds","matches","matchGames","instrumentedMethods","method","getOwnPropertyNames","getPrototypeOf","includes","originalMethod","args","id","start","v4","Date","now","console","log","toUpperCase","result","duration","exports"],"sources":["../src/manager.ts"],"sourcesContent":[null],"mappings":"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"},"metadata":{},"sourceType":"script","externalDependencies":[]}